---
import CardPokemon from './CardPokemon.astro';
import { allPokemonDetails } from '../services/pokemon';
import { typeTranslations } from '../utils/typeTranslations';

const pokemons = await allPokemonDetails();

const pokemonsWithSpanishTypes = pokemons.map((pokemon) => {
  const spanishTypes = pokemon.types.map(({ type }) => typeTranslations[type.name] ?? type.name);
  return { ...pokemon, spanishTypes };
});
---

<div class="w-full" style="--tw-bg-opacity: 1;">
  <!-- Header Hero mejorado -->
  <div class="relative overflow-hidden pt-12 pb-24 px-4 bg-gradient-to-b from-slate-950 via-purple-900 to-slate-900 mb-12">
    <div class="absolute inset-0 -z-10">
      <div class="absolute top-0 left-0 w-96 h-96 bg-red-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20" style="animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;"></div>
      <div class="absolute top-0 right-0 w-96 h-96 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20" style="animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite; animation-delay: 2s;"></div>
      <div class="absolute -bottom-8 left-1/2 w-96 h-96 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20" style="animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite; animation-delay: 4s;"></div>
    </div>
    
    <div class="max-w-6xl mx-auto text-center relative z-10">
      <h1 class="text-7xl md:text-8xl font-black mb-4">
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-500 via-yellow-500 to-red-500">PokÃ©API</span>
      </h1>
      <p class="text-xl md:text-2xl text-gray-300 mb-6">Explora la RegiÃ³n de Kanto</p>
      <div class="flex gap-4 justify-center flex-wrap">
        <div class="px-6 py-2 bg-red-500/20 border border-red-500/50 rounded-full backdrop-blur">
          <p class="text-white font-semibold">150 PokÃ©mon</p>
        </div>
        <div class="px-6 py-2 bg-blue-500/20 border border-blue-500/50 rounded-full backdrop-blur">
          <p class="text-white font-semibold">18 Tipos</p>
        </div>
      </div>
    </div>
  </div>
  <!-- Barra de bÃºsqueda -->
  <div
    class="sticky top-0 z-20 bg-slate-800/80 backdrop-blur-md border-b border-purple-500/20 mb-8 py-6"
  >
    <div class="max-w-2xl mx-auto px-4">
      <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
          <svg
            class="h-5 w-5 text-slate-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            ></path>
          </svg>
        </div>
        <input
          type="text"
          id="pokemon-search"
          placeholder="Busca por nombre o ID..."
          class="block w-full pl-12 pr-4 py-3 text-white bg-slate-800/50 border border-purple-500/30 rounded-lg
                 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/50
                 transition-all duration-300 backdrop-blur-sm"
        />
        <button
          id="clear-search"
          class="absolute inset-y-0 right-0 pr-4 flex items-center opacity-0 transition-opacity duration-200 hover:text-white text-slate-400"
        >
          <svg
            class="h-5 w-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>
      <div
        id="search-stats"
        class="mt-3 text-center"
      >
        <span
          class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-slate-700/50 text-slate-300 border border-purple-500/30"
        >
          <span id="results-count">Cargando...</span>
        </span>
      </div>
    </div>
  </div>

  <!-- Filtros por tipo -->
  <div class="mb-8 px-4">
    <div class="max-w-6xl mx-auto">
      <h3 class="text-lg font-semibold text-white mb-4 text-center">Filtrar por tipo</h3>
      <div
        class="flex flex-wrap justify-center gap-2"
        id="type-filters"
      >
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-slate-700 text-white border-slate-600 hover:bg-slate-600"
          data-type="all"
        >
          Todos
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-red-400 text-black border-red-300 hover:bg-red-300"
          data-type="Fuego"
        >
          ğŸ”¥ Fuego
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-blue-300 text-black border-blue-200 hover:bg-blue-200"
          data-type="Agua"
        >
          ğŸ’§ Agua
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-green-200 text-black border-green-100 hover:bg-green-100"
          data-type="Planta"
        >
          ğŸŒ± Planta
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-yellow-300 text-black border-yellow-200 hover:bg-yellow-200"
          data-type="ElÃ©ctrico"
        >
          âš¡ ElÃ©ctrico
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-pink-300 text-black border-pink-200 hover:bg-pink-200"
          data-type="PsÃ­quico"
        >
          ğŸ”® PsÃ­quico
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-blue-200 text-black border-blue-100 hover:bg-blue-100"
          data-type="Hielo"
        >
          â„ï¸ Hielo
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-indigo-300 text-black border-indigo-200 hover:bg-indigo-200"
          data-type="DragÃ³n"
        >
          ğŸ‰ DragÃ³n
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-gray-600 text-white border-gray-500 hover:bg-gray-500"
          data-type="Siniestro"
        >
          ğŸŒ™ Siniestro
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-red-300 text-black border-red-200 hover:bg-red-200"
          data-type="Lucha"
        >
          ğŸ‘Š Lucha
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-purple-300 text-black border-purple-200 hover:bg-purple-200"
          data-type="Veneno"
        >
          â˜ ï¸ Veneno
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-yellow-200 text-black border-yellow-100 hover:bg-yellow-100"
          data-type="Tierra"
        >
          ğŸŒ Tierra
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-indigo-200 text-black border-indigo-100 hover:bg-indigo-100"
          data-type="Volador"
        >
          ğŸª¶ Volador
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-gray-400 text-black border-gray-300 hover:bg-gray-300"
          data-type="Acero"
        >
          âš™ï¸ Acero
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-pink-200 text-black border-pink-100 hover:bg-pink-100"
          data-type="Hada"
        >
          ğŸ§š Hada
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-gray-300 text-black border-gray-200 hover:bg-gray-200"
          data-type="Normal"
        >
          âšª Normal
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-yellow-300 text-black border-yellow-200 hover:bg-yellow-200"
          data-type="Roca"
        >
          ğŸª¨ Roca
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-green-300 text-black border-green-200 hover:bg-green-200"
          data-type="Bicho"
        >
          ğŸ› Bicho
        </button>
        <button
          class="type-filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border-2 bg-indigo-400 text-white border-indigo-300 hover:bg-indigo-300"
          data-type="Fantasma"
        >
          ğŸ‘» Fantasma
        </button>
      </div>
    </div>
  </div>

  <!-- Grid de PokÃ©mon -->
  <div
    id="pokemon-grid"
    class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3 px-4"
  >
    {
      pokemonsWithSpanishTypes.map((pokemon) => (
        <div
          class="pokemon-card block transition-all duration-300 ease-in-out"
          data-name={pokemon.name.toLowerCase()}
          data-id={pokemon.id.toString()}
          data-types={pokemon.spanishTypes.join(',')}
        >
          <CardPokemon
            name={pokemon.name}
            id={pokemon.id}
            img={
              pokemon.sprites.other?.['official-artwork'].front_default || '/default-pokemon.png'
            }
            types={pokemon.spanishTypes}
          />
        </div>
      ))
    }
  </div>

  <!-- Mensaje cuando no hay resultados -->
  <div
    id="no-results"
    class="hidden text-center py-16 px-4"
  >
    <div class="max-w-md mx-auto">
      <div class="text-6xl mb-6">ğŸ”</div>
      <h3 class="text-2xl font-bold text-white mb-3">No se encontraron PokÃ©mon</h3>
      <p class="text-slate-400 text-lg mb-6">Intenta buscar con otro nombre o ID</p>
      <button
        id="clear-search-btn"
        class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200"
      >
        Limpiar bÃºsqueda
      </button>
    </div>
  </div>

  <!-- BotÃ³n para subir al top -->
  <button
    id="scroll-to-top"
    class="fixed bottom-6 right-6 z-30 w-12 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg transform transition-all duration-300 opacity-0 scale-0 pointer-events-none hover:scale-110 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:ring-offset-slate-800"
    aria-label="Subir al inicio"
  >
    <svg
      class="w-6 h-6 mx-auto"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M5 10l7-7m0 0l7 7m-7-7v18"
      ></path>
    </svg>
  </button>
</div>

<script>
  interface PokemonCard extends HTMLElement {
    dataset: {
      name?: string;
      id?: string;
      types?: string;
    };
  }

  document.addEventListener('DOMContentLoaded', (): void => {
    const searchInput = document.getElementById('pokemon-search') as HTMLInputElement;
    const pokemonGrid = document.getElementById('pokemon-grid') as HTMLElement;
    const noResults = document.getElementById('no-results') as HTMLElement;
    const resultsCount = document.getElementById('results-count') as HTMLElement;
    const clearButton = document.getElementById('clear-search') as HTMLButtonElement;
    const clearBtnNoResults = document.getElementById('clear-search-btn') as HTMLButtonElement;
    const pokemonCards = document.querySelectorAll('.pokemon-card') as NodeListOf<PokemonCard>;
    const typeFilterBtns = document.querySelectorAll(
      '.type-filter-btn'
    ) as NodeListOf<HTMLButtonElement>;
    const scrollToTopBtn = document.getElementById('scroll-to-top') as HTMLButtonElement;

    const totalPokemon: number = pokemonCards.length;
    let currentTypeFilter: string = 'all';
    let currentSearchTerm: string = '';

    // FunciÃ³n para actualizar el contador de resultados
    const updateResultsCount = (
      visible: number,
      total: number,
      searchTerm: string,
      typeFilter: string = 'all'
    ): void => {
      let message = '';
      if (searchTerm === '' && typeFilter === 'all') {
        message = `${total} PokÃ©mon`;
      } else if (searchTerm !== '' && typeFilter !== 'all') {
        message = `${visible} de ${total} PokÃ©mon (${typeFilter} + bÃºsqueda)`;
      } else if (typeFilter !== 'all') {
        message = `${visible} de ${total} PokÃ©mon tipo ${typeFilter}`;
      } else {
        message = `${visible} de ${total} PokÃ©mon`;
      }
      resultsCount.textContent = message;
    };

    // FunciÃ³n para mostrar/ocultar el botÃ³n de limpiar
    const toggleClearButton = (show: boolean): void => {
      clearButton.style.opacity = show ? '1' : '0';
      clearButton.style.pointerEvents = show ? 'auto' : 'none';
    };

    // FunciÃ³n para actualizar estado de botones de tipo
    const updateTypeButtons = (activeType: string): void => {
      typeFilterBtns.forEach((btn: HTMLButtonElement): void => {
        const btnType = btn.dataset.type || 'all';
        if (btnType === activeType) {
          btn.classList.add('ring-2', 'ring-blue-400', 'bg-opacity-80');
        } else {
          btn.classList.remove('ring-2', 'ring-blue-400', 'bg-opacity-80');
        }
      });
    };

    // FunciÃ³n para mostrar/ocultar botÃ³n scroll to top
    const toggleScrollToTopButton = (): void => {
      const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
      const showButton = scrollPosition > 300; // Mostrar despuÃ©s de 300px de scroll

      if (showButton) {
        scrollToTopBtn.classList.remove('opacity-0', 'scale-0', 'pointer-events-none');
        scrollToTopBtn.classList.add('opacity-100', 'scale-100');
      } else {
        scrollToTopBtn.classList.add('opacity-0', 'scale-0', 'pointer-events-none');
        scrollToTopBtn.classList.remove('opacity-100', 'scale-100');
      }
    };

    // FunciÃ³n para hacer scroll suave hacia arriba
    const scrollToTop = (): void => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth',
      });
    };

    // FunciÃ³n principal de filtrado
    const filterPokemon = (
      searchTerm: string = currentSearchTerm,
      typeFilter: string = currentTypeFilter
    ): void => {
      const term = searchTerm.toLowerCase().trim();
      let visibleCount = 0;

      // Filtrar las tarjetas
      pokemonCards.forEach((card: PokemonCard): void => {
        const name = card.dataset.name || '';
        const id = card.dataset.id || '';
        const types = card.dataset.types || '';

        // LÃ³gica de bÃºsqueda por texto/ID
        const matchesName = name.includes(term);
        const isNumericSearch = /^\d+$/.test(term);
        const matchesId = isNumericSearch ? id === term : false;
        const matchesSearch = term === '' || matchesName || matchesId;

        // LÃ³gica de filtro por tipo
        const matchesType = typeFilter === 'all' || types.includes(typeFilter);

        const shouldShow = matchesSearch && matchesType;

        if (shouldShow) {
          card.style.display = 'block';
          // PequeÃ±a animaciÃ³n de entrada
          card.style.opacity = '0';
          card.style.transform = 'translateY(10px)';

          // Usar requestAnimationFrame para la animaciÃ³n suave
          requestAnimationFrame(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          });

          visibleCount++;
        } else {
          // AnimaciÃ³n de salida antes de ocultar
          card.style.opacity = '0';
          card.style.transform = 'translateY(-10px)';

          // Ocultar despuÃ©s de la animaciÃ³n
          setTimeout(() => {
            if (card.style.opacity === '0') {
              card.style.display = 'none';
            }
          }, 300);
        }
      });

      // Manejar estado de no resultados
      if (visibleCount === 0 && (term !== '' || typeFilter !== 'all')) {
        pokemonGrid.classList.add('hidden');
        noResults.classList.remove('hidden');
      } else {
        pokemonGrid.classList.remove('hidden');
        noResults.classList.add('hidden');
      }

      // Actualizar contador y botÃ³n de limpiar
      updateResultsCount(visibleCount, totalPokemon, term, typeFilter);
      toggleClearButton(term !== '');

      // Actualizar variables de estado
      currentSearchTerm = term;
      currentTypeFilter = typeFilter;
    };

    // FunciÃ³n para limpiar todos los filtros
    const clearAllFilters = (): void => {
      searchInput.value = '';
      currentTypeFilter = 'all';
      currentSearchTerm = '';
      updateTypeButtons('all');
      filterPokemon('', 'all');
      searchInput.focus();
    };

    // Event listeners para bÃºsqueda
    searchInput.addEventListener('input', (): void => {
      filterPokemon(searchInput.value, currentTypeFilter);
    });

    searchInput.addEventListener('keydown', (e: KeyboardEvent): void => {
      if (e.key === 'Escape') {
        clearAllFilters();
      }
    });

    clearButton.addEventListener('click', clearAllFilters);
    clearBtnNoResults.addEventListener('click', clearAllFilters);

    // Event listeners para filtros de tipo
    typeFilterBtns.forEach((btn: HTMLButtonElement): void => {
      btn.addEventListener('click', (): void => {
        const selectedType = btn.dataset.type || 'all';
        currentTypeFilter = selectedType;
        updateTypeButtons(selectedType);
        filterPokemon(currentSearchTerm, selectedType);
      });
    });

    // Event listeners para scroll to top
    scrollToTopBtn.addEventListener('click', scrollToTop);
    window.addEventListener('scroll', toggleScrollToTopButton);

    // Verificar posiciÃ³n inicial del scroll
    toggleScrollToTopButton();

    // Inicializar
    updateResultsCount(totalPokemon, totalPokemon, '', 'all');
    toggleClearButton(false);
    updateTypeButtons('all');
  });
</script>
